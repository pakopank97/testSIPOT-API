<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pre-Validador Sipot</title>
    <link href="https://framework-gb.cdn.gob.mx/assets/styles/main.css" rel="stylesheet">
    <style>
        .table-responsive { max-height: 75vh; }
        .table-responsive th { position: sticky; top: 0; z-index: 1; }
    </style>
</head>
<body>
    <main class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Pre-Validador Sipot</h1><hr>
                <div class="well">
                    <div class="form-group">
                        <label for="archivoExcel">Selecciona un archivo de Excel para procesar:</label>
                        <input type="file" id="archivoExcel" class="form-control-file" accept=".xlsx, .xls">
                    </div>
                    <button id="btnProcesar" class="btn btn-primary">Procesar y Validar</button>
                    <p id="status" class="small">Por favor, selecciona un archivo.</p>
                </div>

                <div id="error-container" class="alert alert-danger" style="display: none;">
                    <h4>Reporte de Errores de Formato</h4>
                    <ul id="error-list"></ul>
                </div>

                <div id="warning-container" class="alert alert-warning" style="display: none;">
                    <h4>Advertencias de Celdas Vacías</h4>
                    <ul id="warning-list"></ul>
                </div>
                
                <div id="results-container">
                    <h2 id="report-title"></h2>
                    <div class="table-responsive">
                        <table id="tablaDatos" class="table table-striped table-hover">
                            <thead id="table-headers"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    <div id="download-container" class="text-center" style="margin-top: 20px;">
                        <button id="btnDownload" class="btn btn-success" style="display: none;">Descargar JSON Backend</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://framework-gb.cdn.gob.mx/gobmx.js"></script>
    <script>
        // Referencias a los elementos del DOM
        const btnProcesar = document.getElementById('btnProcesar');
        const statusEl = document.getElementById('status');
        const reportTitleEl = document.getElementById('report-title');
        const tableHeadersEl = document.getElementById('table-headers');
        const tableBodyEl = document.getElementById('table-body');
        const errorContainer = document.getElementById('error-container');
        const errorList = document.getElementById('error-list');
        const warningContainer = document.getElementById('warning-container'); // <-- NUEVO
        const warningList = document.getElementById('warning-list'); // <-- NUEVO
        const btnDownload = document.getElementById('btnDownload');
        const serverUrl = 'http://127.0.0.1:5000/upload';

        function downloadJson(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        btnProcesar.addEventListener('click', async () => {
            const archivo = document.getElementById('archivoExcel').files[0];
            if (!archivo) { return; }

            const formData = new FormData();
            formData.append('archivo', archivo);

            // Limpieza completa de la interfaz
            statusEl.textContent = 'Procesando y validando archivo...';
            reportTitleEl.textContent = '';
            tableHeadersEl.innerHTML = '';
            tableBodyEl.innerHTML = '';
            errorContainer.style.display = 'none';
            errorList.innerHTML = '';
            warningContainer.style.display = 'none'; // <-- NUEVO
            warningList.innerHTML = ''; // <-- NUEVO
            btnDownload.style.display = 'none';

            try {
                const response = await fetch(serverUrl, { method: 'POST', body: formData });
                const result = await response.json();

                if (result.error && !result.rows) throw new Error(result.error);
                
                reportTitleEl.textContent = result.formato;

                // Muestra los errores de formato si existen
                if (result.errors && result.errors.length > 0) {
                    result.errors.forEach(msg => {
                        const li = document.createElement('li');
                        li.textContent = msg;
                        errorList.appendChild(li);
                    });
                    errorContainer.style.display = 'block';
                }

                // NUEVO: Muestra las advertencias de celdas vacías si existen
                if (result.warnings && result.warnings.length > 0) {
                    result.warnings.forEach(msg => {
                        const li = document.createElement('li');
                        li.textContent = msg;
                        warningList.appendChild(li);
                    });
                    warningContainer.style.display = 'block';
                }

                // Lógica para el mensaje de estado y el botón de descarga
                if (result.errors && result.errors.length > 0) {
                    statusEl.innerHTML = `<strong>Proceso completado con ${result.errors.length} errores de formato.</strong>`;
                } else {
                    statusEl.innerHTML = `<strong>Validada la informacion</strong>`;
                    btnDownload.style.display = 'block';
                    btnDownload.onclick = function() {
                        downloadJson(result.json_backend, 'json_backend.json');
                    };
                }
                
                // Renderiza la tabla (sin cambios)
                if (result.headers && result.headers.length > 0) {
                    const headerRow = document.createElement('tr');
                    result.headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        headerRow.appendChild(th);
                    });
                    tableHeadersEl.appendChild(headerRow);
                }
                if (result.rows && result.rows.length > 0) {
                    result.rows.forEach(rowData => {
                        const row = document.createElement('tr');
                        rowData.forEach(cellData => {
                            const td = document.createElement('td');
                            td.textContent = cellData;
                            row.appendChild(td);
                        });
                        tableBodyEl.appendChild(row);
                    });
                }
            } catch (error) {
                statusEl.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        });
    </script>
</body>
</html>